{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "OCIS Application Stack - Contains 1 x Web/App server, 1 x Reporting Server, and a RDS database.",

  "Parameters": {
    "VpcId": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "VpcId of your existing Virtual Private Cloud (VPC)",
      "ConstraintDescription": "The VPC Id of an existing Virtual Private Cloud."
    },

    "PrivSubnet": {
      "Type": "String<AWS::EC2::Subnet::Id>",
      "Description": "The string of the Private SubnetId in your Virtual Private Cloud (VPC)",
      "ConstraintDescription": "Subnet Id"
    },

    "PrivSubnets": {
      "Type": "List<AWS::EC2::Subnet::Id>",
      "Description": "The list of Private SubnetIds in your Virtual Private Cloud (VPC)",
      "ConstraintDescription": "must be a list of at least two existing subnets associated with at least two different availability zones. They should be residing in the selected Virtual Private Cloud."
    },

    "DBName": {
      "Default": "OracleDB",
      "Description": "Oracle database name",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "64",
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters."
    },

    "DBAllocatedStorage": {
      "Default": "5",
      "Description": "The size of the database (Gb)",
      "Type": "Number",
      "MinValue": "5",
      "MaxValue": "1024",
      "ConstraintDescription": "must be between 5 and 1024Gb."
    },

    "DBInstanceClass": {
      "Description": "The database instance type",
      "Type": "String",
      "Default": "db.r5.large",
      "ConstraintDescription": "must select a valid database instance type."
    },

    "MultiAZDatabase": {
      "Default": "true",
      "Description": "Create a Multi-AZ MySQL Amazon RDS database instance",
      "Type": "String",
      "AllowedValues": [ "true", "false" ],
      "ConstraintDescription": "must be either true or false."
    },

    "AppWebInstanceProfile": {
      "Description": "WebServer EC2 IAM instance profile (with read permission to AWS Secrets Manager)",
      "Type": "String",
      "Default": "customer_origin_secrets_manager_instance_profile",
      "AllowedPattern": "^[a-zA-Z0-9-_]*$",
      "ConstraintDescription": "Must be a valid pre-existing EC2 IAM role aka instance profile."
    },

    "AppWebInstanceType": {
      "Description": "WebServer EC2 instance type",
      "Type": "String",
      "Default": "t3.xlarge",
      "ConstraintDescription": "must be a valid EC2 instance type."
    },

    "ReportingInstanceProfile": {
      "Description": "Reporting Server EC2 IAM instance profile (with read permission to AWS Secrets Manager)",
      "Type": "String",
      "Default": "customer_origin_secrets_manager_instance_profile",
      "AllowedPattern": "^[a-zA-Z0-9-_]*$",
      "ConstraintDescription": "Must be a valid pre-existing EC2 IAM role aka instance profile."
    },

    "ReportingInstanceType": {
      "Description": "Reporting Server EC2 instance type",
      "Type": "String",
      "Default": "t3.xlarge",
      "ConstraintDescription": "must be a valid EC2 instance type."
    }

  },

  "Resources": {

    "EC2ServersSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Enable HTTP access via port 80",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp" : "10.0.0.0/16"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "443",
            "ToPort": "443",
            "CidrIp" : "10.0.0.0/16"
          }
        ],
        "VpcId": { "Ref": "VpcId" }
      }
    },

    "AppWebEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "BlockDeviceMappings": [
           {
              "DeviceName": "root",
              "Ebs": {
                "VolumeSize": "100"
              }
           },
                      {
              "DeviceName": "app",
              "Ebs": {
                "VolumeSize": "50"
              }
           },
                      {
              "DeviceName": "data",
              "Ebs": {
                "VolumeSize": "50"
              }
           }
        ],
        "ImageId": "ami-00f409158af899a3e",
        "IamInstanceProfile": { "Ref": "AppWebInstanceProfile" },
        "InstanceType": { "Ref": "AppWebInstanceType" },
        "SecurityGroups" : { "Ref": "EC2ServersSecurityGroup" },
        "SubnetId": { "Ref": "PrivSubnet" }
      }
    },

    "ReportingEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "BlockDeviceMappings": [
           {
              "DeviceName": "root",
              "Ebs": {
                "VolumeSize": "100"
              }
           },
                      {
              "DeviceName": "app",
              "Ebs": {
                "VolumeSize": "150"
              }
           },
                      {
              "DeviceName": "data",
              "Ebs": {
                "VolumeSize": "50"
              }
           }
        ],
        "ImageId": "ami-00f409158af899a3e",
        "IamInstanceProfile": { "Ref": "ReportingInstanceProfile" },
        "InstanceType": { "Ref": "ReportingInstanceType" },
        "SecurityGroups" : { "Ref": "EC2ServersSecurityGroup" },
        "SubnetId": { "Ref": "PrivSubnet" }
      }
    },
    
    "DBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Open database for access",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "1521",
            "ToPort": "1521",
            "SourceSecurityGroupId": { "Ref": "EC2ServersSecurityGroup" }
          }
        ],
        "VpcId": { "Ref": "VpcId" }
      }
    },

    "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupDescription": "Private subnet group",
        "SubnetIds": { "Ref": "PrivSubnets" }
      }
    },

    "OracleDB": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBName": "oracle-db-test",
        "Engine": "oracle-ee",
        "EngineVersion": "12.1.0.2.v7",
        "LicenseModel": "bring-your-own-license",
        "MasterUsername": "{{resolve:secretsmanager:ams-shared/stage-otdb-new:SecretString:Username}}",
        "MasterUserPassword": "{{resolve:secretsmanager:ams-shared/stage-otdb-new:SecretString:Password}}",
        "MultiAZ": { "Ref": "MultiAZDatabase" },
        "DBInstanceClass": { "Ref": "DBInstanceClass" },
        "AllocatedStorage": { "Ref": "DBAllocatedStorage" },
        "DBSubnetGroupName": { "Ref": "DBSubnetGroup" },
        "VPCSecurityGroups": [ { "Fn::GetAtt": [ "DBSecurityGroup", "GroupId" ] } ]
      }
    }
  }
}
