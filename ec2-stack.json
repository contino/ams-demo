{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Creates a single EC2 Instance",
  "Metadata": {
    "RevisionDate": "7-Jun-2016"
  },
  "Parameters": {
    "InstanceAmiId": {
      "Description": "The ID of the AMI to deploy instances with.",
      "Type": "AWS::EC2::Image::Id"
    },
    "InstanceDetailedMonitoring": {
      "Description": "Whether to enable detailed monitoring on the instance.",
      "Type": "String",
      "Default": "false",
      "AllowedValues": [ "true", "false" ]
    },
    "InstanceEBSOptimized": {
      "Description": "Whether the instance is optimized for Amazon Elastic Block Store I/O.",
      "Type": "String",
      "Default": "false",
      "AllowedValues": [ "true", "false" ]
    },
    "InstanceProfile": {
      "Description": "Custom instance profile to be used on the stack.",
      "Type": "String",
      "Default": "customer-mc-ec2-instance-profile"
    },
    "InstanceRootVolumeIops" : {
      "Description": "The Iops to use for the root volume if io1 volume type is specified.",
      "Type": "Number",
      "MinValue": 0,
      "MaxValue": 20000,
      "Default": 0
    },
    "InstanceRootVolumeName": {
      "Description": "The name of the root volume to use.",
      "Type": "String",
      "Default": "/dev/xvda"
    },
    "InstanceRootVolumeSize" : {
      "Description": "The size of the root volume for the instance in GiB.",
      "Type": "Number",
      "MinValue": 8,
      "MaxValue": 16000
    },
    "InstanceRootVolumeType" : {
      "Description": "The type of the root volume for the instance.",
      "Type": "String",
      "AllowedValues": [ "standard", "io1", "gp2" ],
      "Default": "gp2"
    },
    "InstancePrivateStaticIp" : {
      "Description": "The static IP address that the instance can support.",
      "Type": "String",
      "Default": ""
    },
    "InstanceSubnetId": {
      "Description": "The subnet to deploy instances in this stack to.",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "InstanceType": {
      "Description": "The type of EC2 instance to launch.",
      "Type": "String",
      "Default": "t2.large"
    },
    "InstanceUserData": {
      "Description" : "Script to be run on boot.",
      "Type" : "String",
      "Default" : ""
    },
    "SecurityGroups": {
      "Description": "Default Security Groups for the instance.",
      "Type": "List<AWS::EC2::SecurityGroup::Id>"
    }
  },
  "Conditions" : {
    "IsInstanceIo1RootVolumeType" : { "Fn::Equals" : [ { "Ref": "InstanceRootVolumeType" }, "io1" ] },
    "HasPrivateStaticIp" : { "Fn::Not": [ { "Fn::Equals": [ "", { "Ref": "InstancePrivateStaticIp" } ] } ] },
    "HasUserData" : { "Fn::Not": [ { "Fn::Equals": [ "", { "Ref": "InstanceUserData" } ] } ] }
  },
  "Resources": {
    "Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "BlockDeviceMappings": [
           {
              "DeviceName": { "Ref": "InstanceRootVolumeName" },
              "Ebs": {
                "DeleteOnTermination": "true",
                "Iops": {
                  "Fn::If": [ "IsInstanceIo1RootVolumeType",
                              { "Ref": "InstanceRootVolumeIops" },
                              { "Ref" : "AWS::NoValue" }
                  ]
                },
                "VolumeSize": { "Ref": "InstanceRootVolumeSize" },
                "VolumeType": { "Ref": "InstanceRootVolumeType" }
              }
           }
        ],
        "EbsOptimized": { "Ref": "InstanceEBSOptimized" },
        "IamInstanceProfile": { "Ref": "InstanceProfile" },
        "ImageId": { "Ref": "InstanceAmiId" },
        "InstanceInitiatedShutdownBehavior": "stop",
        "InstanceType": { "Ref": "InstanceType" },
        "Monitoring": { "Ref": "InstanceDetailedMonitoring" },
        "PrivateIpAddress": {
            "Fn::If" : [
              "HasPrivateStaticIp",
              { "Ref": "InstancePrivateStaticIp" },
              { "Ref": "AWS::NoValue" }
            ]
        },
        "SecurityGroupIds" : { "Ref": "SecurityGroups" },
        "SubnetId": { "Ref": "InstanceSubnetId" },
        "Tenancy": "default",
        "UserData" : {
          "Fn::If" : [
            "HasUserData",
            { "Fn::Base64" : {"Ref" : "InstanceUserData"} },
            { "Ref": "AWS::NoValue" }
          ]
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Count": 1,
          "Timeout": "PT12H"
        }
      }
    }
  },
  "Outputs": {
    "InstanceId": {
      "Description": "Instance Id of the newly created instance.",
      "Value": { "Ref": "Instance" }
    },
    "InstancePrivateIP": {
      "Description": "Private IP address of the new newly created instance.",
      "Value": { "Fn::GetAtt": [ "Instance", "PrivateIp" ] }
    }
  }
}
